---
- name: Deploy Flask app to Apache servers
  hosts: apache_servers
  become: true
  vars:
    flask_app_path: /var/www/flaskapp
    flask_repo_url: "https://tu-repo-git/tu-flask-app.git"  # Opcional, si tienes tu app en Git
    flask_venv_path: /var/www/flaskapp/venv
  tasks:

    - name: Install required packages 
      apt:
        name:
          - apache2
          - libapache2-mod-wsgi-py3
          - python3-pip
          - python3-venv
          - git
        state: present
        update_cache: yes

    - name: Create Flask app directory
      file:
        path: "{{ flask_app_path }}"
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

    - name: Create virtual environment
      ansible.builtin.command: "python3 -m venv {{ flask_venv_path }}"

    - name: Install flask inside virtual env
      ansible.builtin.command: "{{ flask_venv_path }}/bin/pip install flask"

    - name: Deploy Flask app (simple "Hello World" if no repo)
      copy:
        dest: "{{ flask_app_path }}/app.py"
        content: |
          from flask import Flask, render_template
          import os
          import platform

          app = Flask(__name__)

          @app.route('/')
          def home():
              return f"<h1>Servidor: {platform.node()}</h1><p>SO: {platform.system()} {platform.release()}</p>"

          @app.route('/restart_apache')
          def restart_apache():
              os.system('sudo systemctl restart apache2')
              return "Apache reiniciado"

          @app.route('/restart_zabbix')
          def restart_zabbix():
              os.system('sudo systemctl restart zabbix-agent')
              return "Zabbix Agent reiniciado"

          if __name__ == "__main__":
              app.run(host="0.0.0.0")

    - name: Create WSGI entry point
      copy:
        dest: "{{ flask_app_path }}/app.wsgi"
        content: |
          import sys
          sys.path.insert(0, "{{ flask_app_path }}")
          from app import app as application

    - name: Configure Apache for Flask app
      copy:
        dest: /etc/apache2/sites-available/flaskapp.conf
        content: |
          <VirtualHost *:80>
              ServerName localhost
              WSGIDaemonProcess flaskapp threads=5
              WSGIScriptAlias / {{ flask_app_path }}/app.wsgi

              <Directory {{ flask_app_path }}>
                  Require all granted
              </Directory>

              Alias /static {{ flask_app_path }}/static
              <Directory {{ flask_app_path }}/static/>
                  Require all granted
              </Directory>

              ErrorLog ${APACHE_LOG_DIR}/error.log
              CustomLog ${APACHE_LOG_DIR}/access.log combined
          </VirtualHost>

    - name: Enable Flask app site
      shell: |
        a2ensite flaskapp.conf
        a2dissite 000-default.conf
        systemctl reload apache2
